declare @iNamLamViec int							set @iNamLamViec = 2018declare @iID_MaPhongBan nvarchar(20)				set @iID_MaPhongBan='10' declare @iID_MaNguonNganSach nvarchar(20)			set @iID_MaNguonNganSach = '2'declare @iID_MaNamNganSach nvarchar(20)				set @iID_MaNamNganSach = '2'declare @iID_MaDonVi nvarchar(10)					set @iID_MaDonVi = '22'	declare @dNgayChungTu datetime						set @dNgayChungTu = GETDATE()declare @iThang_Quy		int							set @iThang_Quy=2declare @iSoChungTu int	set @iSoChungTu = 4DECLARE @sLNS0 nvarchar(max) set @sLNS0 = '1010000'DECLARE @loai int set @loai = 3DECLARE @dvt int set @dvt = 1--###--declare @iID_MaChungTu nvarchar(MAX)set @iID_MaChungTu = [dbo].f_ns_dtbs_chungtu_gom(@iNamLamViec,@iID_MaPhongBan)SELECT iID_MaMucLucNganSach,iID_MaMucLucNganSach_Cha,bLaHangCha,mlns.sXauNoiMa, mlns.sLNS, mlns.sL, mlns.sK, mlns.sM, mlns.sTM, mlns.sTTM, mlns.sNG, mlns.sTNG, mlns.sMoTa, @@dsDuocNhapTruongTien, null as bDongY, null as sLyDo, quyettoan.rDaQuyetToan, chitieu.rTuChi AS rChiTieuFROM NS_MucLucNganSach mlnsLEFT JOIN (select  sLNS,sL,sK,sM,sTM,sTTM,sNG,sXauNoiMa,   rDaQuyetToan =sum(rTuChi)from  QTA_ChungTuChiTietwhere  iTrangThai=1   and iNamLamViec=@iNamLamViec   and iID_MaNamNganSach=@iID_MaNamNganSach   and iID_MaPhongBan=@iID_MaPhongBan   and iID_MaDonVi=@iID_MaDonVi   and (iThang_Quy<@iThang_Quy     or (iThang_Quy=@iThang_Quy       and iID_MaChungTu in ( select iID_MaChungTu from QTA_ChungTu            where iTrangThai=1               and iNamLamViec=@iNamLamViec              and (dNgayChungTu<@dNgayChungTu or (dNgayChungTu=@dNgayChungTu and iSoChungTu <@iSoChungTu)))))group by sLNS,sL,sK,sM,sTM,sTTM,sNG,sXauNoiMa) quyettoan ON quyettoan.sXauNoiMa = mlns.sXauNoiMaLEFT JOIN (-- du toanSELECT  		sLNS1=LEFT(sLNS,1),       		sLNS3	=LEFT(sLNS,3), 		sLNS5	=LEFT(sLNS,5),      		sLNS,        sL,sK,sM,sTM,sTTM,sNG,sMoTa,		sXauNoiMa = CONVERT(nvarchar(10),sLNS)+'-'+					CONVERT(nvarchar(10),sL)+'-'+					CONVERT(nvarchar(10),sK)+'-'+					CONVERT(nvarchar(10),sM)+'-'+					CONVERT(nvarchar(10),sTM)+'-'+					CONVERT(nvarchar(10),sTTM)+'-'+					CONVERT(nvarchar(10),sNG),        iID_MaDonVi,		dv.sTenDonVi, 		iID_MaPhongBan,        rTuChi		=SUM(rTuChi)/@dvt,        rHienVat	=SUM(rHienVat)/@dvt,        rTonKho		=SUM(rTonKho)/@dvt,        rHangNhap	=SUM(rHangNhap)/@dvt,        rHangMua	=SUM(rHangMua)/@dvt,        rPhanCap	=SUM(rPhanCap)/@dvt,        rDuPhong	=SUM(rDuPhong)/@dvtFROM (     --DU TOAN    SELECT                  sLNS=   CASE                WHEN sLNS='1020000' then '1020100'            else sLNS END,			sL,sK,sM,sTM,sTTM,sNG,sMoTa,sXauNoiMa,            iID_MaDonVi,			iID_MaPhongBan = iID_MaPhongBanDich,			loai = 1,            rTuChi		=SUM(rTuChi+rChiTaiNganh),            rHienVat	=SUM(rHienVat),            rTonKho		=SUM(rTonKho),            rHangNhap	=SUM(rHangNhap),            rHangMua	=SUM(rHangMua),            rPhanCap	=SUM(rPhanCap),            rDuPhong	=SUM(rDuPhong)    FROM    DT_ChungTuChiTiet     WHERE   iTrangThai <> 0            AND iNamLamViec=@iNamLamViec 			AND (@iID_MaNamNganSach is null or iID_MaNamNganSach IN (SELECT * FROM f_split(@iID_MaNamNganSach)))			AND (@iID_MaNguonNganSach is null or iID_MaNguonNganSach  IN (SELECT * FROM f_split(@iID_MaNguonNganSach)))			AND (((sLNS like '104%' and (MaLoai='' OR MaLoai='2') ) or (sLNS not like '104%')))			AND (@iID_MaPhongBan is null or iID_MaPhongBanDich in (select * from f_split(@iID_MaPhongBan)))			AND (@iID_MaDonVi is null or iID_MaDonVi in (select * from f_split(@iID_MaDonVi)))        GROUP BY sLNS,sL,sK,sM,sTM,sTTM,sNG,sMoTa,sXauNoiMa,iID_MaDonVi,iID_MaPhongBanDich    HAVING SUM(rTuChi+rChiTaiNganh)<>0 OR SUM(rHienVat)<>0 OR SUM(rTonKho)<>0 OR SUM(rHangNhap)<>0 OR SUM(rHangMua)<>0 OR SUM(rPhanCap)<>0 OR SUM(rDuPhong)<>0    UNION ALL    -- DU TOAN - PHAN CAP    SELECT   			sLNS=   CASE                WHEN sLNS='1020000' then '1020100'            else sLNS END,			--sLNS,            sL,sK,sM,sTM,sTTM,sNG,sMoTa,sXauNoiMa,            iID_MaDonVi,			iID_MaPhongBan = iID_MaPhongBanDich,			loai = 1,                        rTuChi		=SUM(rTuChi+rChiTaiNganh),            rHienVat	=SUM(rHienVat),            rTonKho		=SUM(rTonKho),            rHangNhap	=SUM(rHangNhap),            rHangMua	=SUM(rHangMua),            rPhanCap	=SUM(rPhanCap),            rDuPhong	=SUM(rDuPhong)    FROM    DT_ChungTuChiTiet_PhanCap     WHERE   iTrangThai <> 0             AND iNamLamViec=@iNamLamViec 			AND (@iID_MaNamNganSach is null or iID_MaNamNganSach IN (SELECT * FROM f_split(@iID_MaNamNganSach)))			AND (@iID_MaNguonNganSach is null or iID_MaNguonNganSach  IN (SELECT * FROM f_split(@iID_MaNguonNganSach)))			AND (@iID_MaPhongBan is null or iID_MaPhongBanDich in (select * from f_split(@iID_MaPhongBan)))			AND (@iID_MaDonVi is null or iID_MaDonVi in (select * from f_split(@iID_MaDonVi)))        GROUP BY sLNS,sL,sK,sM,sTM,sTTM,sNG,sMoTa,sXauNoiMa,iID_MaDonVi,iID_MaPhongBanDich    	HAVING SUM(rTuChi)<>0 OR SUM(rHienVat)<>0 OR SUM(rTonKho)<>0 OR SUM(rHangNhap)<>0 OR SUM(rHangMua)<>0 OR SUM(rPhanCap)<>0 OR SUM(rDuPhong)<>0                                                    UNION ALL    ---- BO SUNG    SELECT              sLNS=   CASE                WHEN sLNS='1020000' then '1020100'            else sLNS END,			--sLNS,			sL,sK,sM,sTM,sTTM,sNG,sMoTa,sXauNoiMa,            iID_MaDonVi, 			iID_MaPhongBan = iID_MaPhongBanDich,			loai = 2,            rTuChi		=SUM(rTuChi+rChiTaiNganh),            rHienVat	=SUM(rHienVat),            rTonKho		=SUM(rTonKho),            rHangNhap	=SUM(rHangNhap),            rHangMua	=SUM(rHangMua),            rPhanCap	=SUM(rPhanCap),            rDuPhong	=SUM(rDuPhong)        FROM DTBS_ChungTuChiTiet         WHERE  iTrangThai <> 0             AND iNamLamViec=@iNamLamViec 			AND (@iID_MaNamNganSach is null or iID_MaNamNganSach IN (SELECT * FROM f_split(@iID_MaNamNganSach)))			AND (@iID_MaNguonNganSach is null or iID_MaNguonNganSach  IN (SELECT * FROM f_split(@iID_MaNguonNganSach)))			AND (@iID_MaPhongBan is null or iID_MaPhongBanDich in (select * from f_split(@iID_MaPhongBan)))            AND MaLoai=''			AND (@iID_MaDonVi is null or iID_MaDonVi in (select * from f_split(@iID_MaDonVi)))			AND (iID_MaNamNganSach <>'2' or iID_MaChungTu IN (select * from f_ns_dtbs_chungtugom_dendot(@iNamLamViec,@iID_MaNamNganSach,@iID_MaPhongBan,@dNgayChungTu)))			and ((iBKhac=0 and iID_MaPhongBan = iID_MaPhongBanDich) or (iBKhac = 1 and iID_MaPhongBan <> iID_MaPhongBanDich) and iID_MaPhongBan = '02')			and  (					--b7					(iID_MaPhongBanDich='07' and (iID_MaNamNganSach<>'2' or (iID_MaNamNganSach='2' and sLNS not like '3%')))				or	(iID_MaPhongBanDich<>'07')				 )                GROUP BY sLNS,sL,sK,sM,sTM,sTTM,sNG,sMoTa,sXauNoiMa,iID_MaDonVi,iID_MaPhongBanDich    HAVING SUM(rTuChi+rChiTaiNganh)<>0 OR SUM(rHienVat)<>0 OR SUM(rTonKho)<>0 OR SUM(rHangNhap)<>0 OR SUM(rHangMua)<>0 OR SUM(rPhanCap)<>0 OR SUM(rDuPhong)<>0	UNION ALL    ---- BO SUNG PHAN CAP LAN 2    SELECT              sLNS=   CASE                WHEN sLNS='1020000' then '1020100'            else sLNS END,			--sLNS,			sL,sK,sM,sTM,sTTM,sNG,sMoTa,sXauNoiMa,            iID_MaDonVi, 			iID_MaPhongBan = iID_MaPhongBanDich,			loai = 2,            rTuChi		=SUM(rTuChi),            rHienVat	=SUM(rHienVat),            rTonKho		=SUM(rTonKho),            rHangNhap	=SUM(rHangNhap),            rHangMua	=SUM(rHangMua),            rPhanCap	=SUM(rPhanCap),            rDuPhong	=SUM(rDuPhong)        FROM	DTBS_ChungTuChiTiet         WHERE   iID_MaChungTuChiTiet in (select maChungTu from F_NS_DSCtuctBSPCLan2_TheoDotGom_Bql(@iNamLamViec, @iID_MaPhongBan))					AND (@iID_MaNamNganSach is null or iID_MaNamNganSach IN (SELECT * FROM f_split(@iID_MaNamNganSach)))				and iTrangThai <> 0 				AND (@iID_MaDonVi is null or iID_MaDonVi in (select * from f_split(@iID_MaDonVi)))				and (rTuChi	+ rHangNhap + rHangMua + rPhanCap) <> 0                GROUP BY sLNS,sL,sK,sM,sTM,sTTM,sNG,sMoTa,sXauNoiMa,iID_MaDonVi,iID_MaPhongBanDich    HAVING SUM(rTuChi+rChiTaiNganh)<>0 OR SUM(rHienVat)<>0 OR SUM(rTonKho)<>0 OR SUM(rHangNhap)<>0 OR SUM(rHangMua)<>0 OR SUM(rPhanCap)<>0 OR SUM(rDuPhong)<>0				/*			NS Phan cap --	*/	 UNION ALL	 SELECT                sLNS=   CASE                WHEN sLNS='1020000' then '1020100'            else sLNS END,			--sLNS,                    sL,sK,sM,sTM,sTTM,sNG,sMoTa,sXauNoiMa,            iID_MaDonVi,    			iID_MaPhongBan,			loai = 2,			                   rTuChi		=SUM(rTuChi),            rHienVat	=SUM(rHienVat),            rTonKho		=SUM(rTonKho),            rHangNhap	=SUM(rHangNhap),            rHangMua	=SUM(rHangMua),            rPhanCap	=SUM(rPhanCap),            rDuPhong	=SUM(rDuPhong)	from [dbo].[f_ns_phancap_bql](@iNamLamViec,@iID_MaNamNganSach,@iID_MaPhongBan,@iID_MaDonVi,@dNgayChungTu)	GROUP BY sLNS,sL,sK,sM,sTM,sTTM,sNG,sMoTa,sXauNoiMa,iID_MaDonVi,iID_MaPhongBan    HAVING SUM(rTuChi)<>0 OR SUM(rHienVat)<>0 OR SUM(rTonKho)<>0 OR SUM(rHangNhap)<>0 OR SUM(rHangMua)<>0 OR SUM(rPhanCap)<>0 OR SUM(rDuPhong)<>0		/*			NS đặc biệt --			B10:	lấy từ dtbs			B7:		lấy từ cấp phát	*/	UNION ALL	SELECT		 sLNS=   CASE                WHEN sLNS='1020000' then '1020100'            else sLNS END,			--sLNS,                    sL,sK,sM,sTM,sTTM,sNG,sMoTa,sXauNoiMa,            iID_MaDonVi,    			iID_MaPhongBan,			loai = 2			,SUM(rTuChi/@dvt) AS rTuChi,			rHienVat	=0,            rTonKho		=0,            rHangNhap	=0,            rHangMua	=0,            rPhanCap	=0,            rDuPhong	=0	FROM		CP_CapPhatChiTiet 	WHERE		iTrangThai=1 				AND iNamLamViec=@iNamLamViec 				AND sLNS like '3%'				AND (@iID_MaNamNganSach IS NULL OR iID_MaNamNganSach IN (SELECT * FROM F_Split(@iID_MaNamNganSach)))				AND (@iID_MaNguonNganSach is null or iID_MaNguonNganSach  IN (SELECT * FROM f_split(@iID_MaNguonNganSach)))				AND (@iID_MaDonVi is null or iID_MaDonVi in (select * from f_split(@iID_MaDonVi)))				AND (@iID_MaPhongBan is null or iID_MaPhongBan in (select * from f_split(@iID_MaPhongBan)))				and iID_MaPhongBan='07'	GROUP BY	sLNS,sL,sK,sM,sTM,sTTM,sNG,sMoTa,sXauNoiMa,iID_MaDonVi,iID_MaPhongBan	HAVING		SUM(rTuChi/@dvt)<>0) as ct-- lay ten don vileft join (select iID_MaDonVi as dv_id, sTenDonVi= iID_MaDonVi + ' - ' + sTen from NS_DonVi where iTrangThai=1 and iNamLamViec_DonVi=@iNamLamViec) as dvon dv.dv_id=ct.iID_MaDonViWHERE			LEFT(sLNS,1) IN (1,2,3,4) 		and (@loai is null or loai in (select * from f_split(@loai)))GROUP BY sLNS,sL,sK,sM,sTM,sTTM,sNG,sMoTa,iID_MaDonVi,sTenDonVi,iID_MaPhongBanHAVING SUM(rTuChi)<>0 OR SUM(rHienVat)<>0 OR  SUM(rTonKho)<>0 OR SUM(rHangNhap)<>0 OR SUM(rHangMua)<>0 OR SUM(rPhanCap)<>0 OR SUM(rDuPhong)<>0) chitieu ON chitieu.sXauNoiMa = mlns.sXauNoiMaWHERE iNamLamViec=@iNamLamViec AND iTrangThai=1 AND @@dk ORDER BY @@dsTruongSapXep;